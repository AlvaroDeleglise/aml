

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Categorical Variables &#8212; Applied Machine Learning in Python</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/mystnb.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .secondtoggle, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Missing Values" href="08-imputation.html" />
    <link rel="prev" title="Preprocessing and Scaling" href="03-preprocessing.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Applied Machine Learning in Python</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  
  <ul class="nav sidenav_l1">
  <li class="">
    <a href="../index.html">1. Welcome</a>
  </li>
  <li class="">
    <a href="../00-introduction/00-introduction.html">2. Introduction</a>
  </li>
  <li class="active">
    <a href="00-ml-workflow.html">3. The Machine Learning Workflow</a>
  <ul class="nav sidenav_l2">
    <li class="">
      <a href="01-data-loading.html">3.1 Data Loading and Basic Preprocessing</a>
    </li>
    <li class="">
      <a href="02-supervised-learning.html">3.2 Supervised learning</a>
    </li>
    <li class="">
      <a href="03-preprocessing.html">3.3 Preprocessing and Scaling</a>
    </li>
    <li class="active">
      <a href="">3.4 Categorical Variables</a>
    </li>
    <li class="">
      <a href="08-imputation.html">3.5 Missing Values</a>
    </li>
    <li class="">
      <a href="10-model-validation-and-tuning.html">3.6 Model evaluation</a>
    </li>
    <li class="">
      <a href="12-pipelines-gridsearch.html">3.7 Combining Pipelines and Model Evaluation</a>
    </li>
  </ul>
  </li>
  <li class="">
    <a href="../02-supervised-learning/index.html">4. Supervised Learning Algorithms</a>
  </li>
  <li class="">
    <a href="../03-unsupervised-learning/index.html">5. Unsupervised Learning Algorithms</a>
  </li>
  <li class="">
    <a href="../04-model-evaluation/index.html">6. Model Evaluation</a>
  </li>
  <li class="">
    <a href="../05-advanced-topics/index.html">7. Advanced Topics</a>
  </li>
</ul>
</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse" data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation" title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i class="fas fa-download"></i></button>

            
            <div class="dropdown-buttons">
                <!-- ipynb file if we had a myst markdown file -->
                
                <!-- Download raw file -->
                <a class="dropdown-buttons" href="../_sources/01-ml-workflow/04-categorical-variables.ipynb.txt"><button type="button" class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip" data-placement="left">.ipynb</button></a>
                <!-- Download PDF via print -->
                <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF" onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
            </div>
            
        </div>

        <!-- Source interaction buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
            <div class="dropdown-buttons sourcebuttons">
                <a class="repository-button" href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left" title="Source repository"><i class="fab fa-github"></i>repository</button></a>
                <a class="issues-button" href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F01-ml-workflow/04-categorical-variables.html&body=Your%20issue%20content%20here."><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left" title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
                
            </div>
        </div>
        

        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->
        
        <div class="dropdown-buttons-trigger">
            <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
            <div class="dropdown-buttons">
                
                <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/01-ml-workflow/04-categorical-variables.ipynb"><button type="button" class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip" data-placement="left"><img class="binder-button-logo" src="../_static/images/logo_binder.svg" alt="Interact on binder">Binder</button></a>
                
                
                
            </div>
        </div>
        
    </div>
    <div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#ordinal-encoding" class="nav-link">Ordinal encoding</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#one-hot-encoding" class="nav-link">One-Hot Encoding</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#aligning-dataframes-with-pandas" class="nav-link">Aligning dataframes with pandas</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#one-hot-with-sklearn" class="nav-link">One-hot with sklearn</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#selecting-columns-in-sklearn" class="nav-link">Selecting Columns in sklearn</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#combining-columntransformer-and-pipeline" class="nav-link">Combining ColumnTransformer and Pipeline</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#selecting-columns-by-type" class="nav-link">Selecting columns by type</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#collinearity-redundancy" class="nav-link">Collinearity & Redundancy</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#dropping-redundant-binary-features" class="nav-link">Dropping redundant binary features</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#impact-encoding-dealing-with-many-categories" class="nav-link">Impact Encoding & Dealing with many categories</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#impact-encoding" class="nav-link">Impact encoding</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#summary" class="nav-link">Summary</a>
        </li>
    
    </ul>
</nav>


    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="categorical-variables">
<h1>Categorical Variables<a class="headerlink" href="#categorical-variables" title="Permalink to this headline">¶</a></h1>
<p>In the last section we talked about scaling for continuous features, which all the features in the cancer dataset were.
In the lending club data, we also saw another type of feature, categorical or discrete features. Categorical or discrete features are those can take one of several distinct values that are usually not numerical, and often not even ordered. In the lending club data, examples were the grade, which could be a letter from ‘A’ to ‘G’, or home ownership, which could be ‘RENT’, ‘MORTGAGE’, ‘OWN’ or ‘ANY’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;C:/Users/t3kci/Downloads/loan.csv/loan.csv&quot;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="stderr docutils container">
<pre class="stderr literal-block">C:\Users\t3kci\anaconda3\lib\site-packages\IPython\core\interactiveshell.py:3063: DtypeWarning: Columns (123,124,125,128,129,130,133,139,140,141) have mixed types.Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)
</pre>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="o">.</span><span class="n">grade</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;C&#39;, &#39;D&#39;, &#39;B&#39;, &#39;A&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="o">.</span><span class="n">home_ownership</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;RENT&#39;, &#39;MORTGAGE&#39;, &#39;OWN&#39;, &#39;ANY&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Most machine learning algorithms require that we preprocess these features into some numeric encoding before we can use them. For our old friend <code class="docutils literal notranslate"><span class="pre">KNeighborsClassifier</span></code>, we could in theory define a distance metric on these categorical features (which is certainly possible and many options exist), though the simpler and more common approach is to transform the data so we can use the standard euclidean distance on all the features.
Let’s take a small subset of the data to investigate the possible preprocessing methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># look only at the two loan statuses we discussed in Chapter TODO</span>
<span class="n">loans_paid</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="n">loans</span><span class="o">.</span><span class="n">loan_status</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Fully Paid&#39;</span><span class="p">,</span> <span class="s1">&#39;Charged Off&#39;</span><span class="p">])]</span>
<span class="c1"># For this example, we want some paid and some charged off loans</span>
<span class="c1"># we group them to make sure we get some of both. We then take the first 100 and remove the grouping index</span>
<span class="n">some_loans</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;loan_status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># we only consider three relatively well-behaved features and the loan status</span>
<span class="n">small_data</span> <span class="o">=</span> <span class="n">some_loans</span><span class="p">[[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">,</span> <span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;loan_status&#39;</span><span class="p">]]</span>
<span class="n">small_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>home_ownership</th>
      <th>grade</th>
      <th>loan_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>RENT</td>
      <td>E</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4800</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>6</th>
      <td>35000</td>
      <td>RENT</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>7</th>
      <td>15000</td>
      <td>OWN</td>
      <td>B</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>8</th>
      <td>16000</td>
      <td>RENT</td>
      <td>B</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>9</th>
      <td>25000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30000</td>
      <td>MORTGAGE</td>
      <td>D</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>11</th>
      <td>40000</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>20000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>13</th>
      <td>4500</td>
      <td>RENT</td>
      <td>B</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>14</th>
      <td>8425</td>
      <td>MORTGAGE</td>
      <td>E</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>15</th>
      <td>20000</td>
      <td>RENT</td>
      <td>D</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>16</th>
      <td>6600</td>
      <td>RENT</td>
      <td>B</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2500</td>
      <td>RENT</td>
      <td>C</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>18</th>
      <td>4000</td>
      <td>MORTGAGE</td>
      <td>D</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2700</td>
      <td>OWN</td>
      <td>A</td>
      <td>Fully Paid</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The loan amount is a continuous feature; it’s an integer amount, but grade and home ownership are categorical. The loan_status is our classification target (which means it’s also a discrete variable, but we don’t consider it a feature and won’t process it as such).
Scikit-learn requires you to explicitly handle categorical features in most cases, which is unlike some other libraries and frameworks. However, that gives you more control over the processing, and a better idea of what happens to your data.</p>
<p>The encoding that is most appropriate depends on the model you’re using, but there are some general encoding schemes that are frequently used.</p>
<div class="section" id="ordinal-encoding">
<h2>Ordinal encoding<a class="headerlink" href="#ordinal-encoding" title="Permalink to this headline">¶</a></h2>
<p>One of the simplest ways to encode categorical data is to assign an integer to each category. You could do this with the <code class="docutils literal notranslate"><span class="pre">OrdinalEncoder</span></code> in scikit-learn, or with pandas by using pandas categorical data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract a column and convert it to categorical data (it was represented as strings before)</span>
<span class="n">home_ownership_cat</span> <span class="o">=</span> <span class="n">small_data</span><span class="o">.</span><span class="n">home_ownership</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">home_ownership_cat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0     MORTGAGE
1     MORTGAGE
2     MORTGAGE
3         RENT
4     MORTGAGE
5     MORTGAGE
6         RENT
7          OWN
8         RENT
9     MORTGAGE
10    MORTGAGE
11    MORTGAGE
12    MORTGAGE
13        RENT
14    MORTGAGE
15        RENT
16        RENT
17        RENT
18    MORTGAGE
19         OWN
Name: home_ownership, dtype: category
Categories (3, object): [MORTGAGE, OWN, RENT]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get integer codes from the categorical data</span>
<span class="c1"># all categorical operations are accessible through the cat attribute:</span>
<span class="n">home_ownership_cat</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0     0
1     0
2     0
3     2
4     0
5     0
6     2
7     1
8     2
9     0
10    0
11    0
12    0
13    2
14    0
15    2
16    2
17    2
18    0
19    1
dtype: int8
</pre></div>
</div>
</div>
</div>
<p>We could create a new dataframe using these integer codes, which now could be interpreted by a machine learning model. However, this is often problematic as this imposes an order and a distance between the different categories, that might not accurately reflect the semantics of the data. Both pandas and scikit-learn by default use the lexical ordering of categories, so MORTGAGE corresponds to 0, OWN to 1 and RENT to 2. This order makes little sense. We could specify our own ordering, say RENT, MORTGAGE, OWN (describing degrees of ownership) but this is also not entirely satisfactory: if we encode it using integers, we postulate that the difference between RENT and MORTGAGE is the same as the difference between MORTGAGE and OWN, and the difference between RENT and OWN is twice the distance between MORTGAGE and OWN. Making these assumption seems somewhat questionable, and in many cases, even ordering the categories might be hard - imagine working on a dataset of cars that includes the color, imposing any ordering there seems very arbitray.</p>
<p>For the grades, using integer encodings might be reasonable, as there is a clear ordering and distance. Whether this is appropriate might depend on the model you are using. If there is very few categories, such as here, it’s probably a safer bet to forego the ordinal encoding and use a different scheme instead.</p>
</div>
<div class="section" id="one-hot-encoding">
<h2>One-Hot Encoding<a class="headerlink" href="#one-hot-encoding" title="Permalink to this headline">¶</a></h2>
<p>The most commonly used encoding scheme for categorical variables by far is the so-called one-hot encoding or dummy encoding. The idea behind one-hot encoding is to add a new column for each value of a categorical variable, and set the column to 1 for the category that applies to the row, and 0 for all the other categories. An easy way to compute this encoding is the <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> function in pandas:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">small_data</span><span class="p">[[</span><span class="s1">&#39;grade&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>grade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
    </tr>
    <tr>
      <th>3</th>
      <td>E</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_data</span><span class="p">[[</span><span class="s1">&#39;grade&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As you can see, <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> replaced the one column <code class="docutils literal notranslate"><span class="pre">grade</span></code> by five columns, one for each possible value. The original value for the grade of first row was <code class="docutils literal notranslate"><span class="pre">A</span></code> so the new column <code class="docutils literal notranslate"><span class="pre">grade_A</span></code> has a 1, while all the other columns have a 0.
We can also call <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> on the whole dataframe. In this case, it will apply dummy encoding to all the columns that have either categorical data or objects (including strings):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_data</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
      <th>loan_status_Charged Off</th>
      <th>loan_status_Fully Paid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As you can see, <code class="docutils literal notranslate"><span class="pre">loan_amnt</span></code> wasn’t changed, while the dummy encoding was applied to all the other columns, including the target <code class="docutils literal notranslate"><span class="pre">loan_status</span></code>. As we don’t want to encode this column, we can explicitly provide the columns that we want to encode:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>loan_status</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a categorical variable was already represented as an integer you can force pandas to apply dummy encoding by passing the column name to the <code class="docutils literal notranslate"><span class="pre">columns</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">pd.get_dummies</span></code>.</p>
</div>
<div class="section" id="aligning-dataframes-with-pandas">
<h3>Aligning dataframes with pandas<a class="headerlink" href="#aligning-dataframes-with-pandas" title="Permalink to this headline">¶</a></h3>
<p>A common problem in using <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> is that if you have multiple datasets or files, and you call <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> on each of them, you might get inconsistent encodings.
Let’s split our toy data into training and test set and apply <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> on them separately:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">small_train</span><span class="p">,</span> <span class="n">small_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">small_data</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
<span class="c1"># To avoid setting with copy warnings we copy the data after splitting</span>
<span class="c1"># this is probably not necessary</span>
<span class="n">small_train</span> <span class="o">=</span> <span class="n">small_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">small_test</span> <span class="o">=</span> <span class="n">small_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>loan_status</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>2500</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>4000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>40000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>35000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>8425</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>20000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>16000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>6600</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>20000</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>25000</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_test</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>loan_status</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>15000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2700</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>4500</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4800</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Both of the dataframes have seven columns, but the meaning of the columns is quite different. The training set doesn’t have a column for <code class="docutils literal notranslate"><span class="pre">home_ownership=OWN</span></code> while the test set doesn’t have a column for <code class="docutils literal notranslate"><span class="pre">grade=E</span></code>.
However, remember that scikit-learn doesn’t know about column names in dataframes, so if you’d passed this data directly into scikit-learn, you would get meaningless predictions without knowing it! TODO callout?</p>
<p>There’s several ways to avoid this; the easiest is to use <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> before splitting the data, that might not be possible if new data arrives and you want to apply an existing model.
Another way is to encode all categorical variables using the pandas categorical type, and specifying all the known categories:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ownership_cats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MORTGAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;OWN&#39;</span><span class="p">,</span> <span class="s1">&#39;RENT&#39;</span><span class="p">]</span>
<span class="n">grade_cats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">]</span>

<span class="n">small_test_explicit_cats</span> <span class="o">=</span> <span class="n">small_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">small_test_explicit_cats</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">small_test_explicit_cats</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">ownership_cats</span><span class="p">)</span>
<span class="n">small_test_explicit_cats</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">small_test_explicit_cats</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">grade_cats</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now the columns are aware of all possible values, and all of them will receive a column, whether the value is present or not (not the all-zero column <code class="docutils literal notranslate"><span class="pre">grade_E</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_test_explicit_cats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>loan_status</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>15000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2700</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>4500</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4800</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This method is very explicit and safe, but can be a bit cumbersome if there’s many categorical columns, or not all of the categories are known beforehand.
A somewhat simpler and less explicit method is using <code class="docutils literal notranslate"><span class="pre">pd.align</span></code> after calling <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute dummy encoding (the columns will not match afterwards)</span>
<span class="n">small_train_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
<span class="n">small_test_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">small_test</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>

<span class="c1"># align dataframes</span>
<span class="c1"># join=&#39;right&#39; aligns test (left=self) to train (right=other) keeping only the columns in train</span>
<span class="c1"># axis=1 means we align only the columns, and don&#39;t try joining the row indices</span>
<span class="c1"># align returns two aligned frames; because we did a right join, train is unchanged</span>
<span class="c1"># so we can discard the second return value (and assign it to _)</span>
<span class="c1"># fill value specifies what to put into previously non-existing columns</span>
<span class="n">test_aligned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">small_test_dummies</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">small_train_dummies</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_aligned</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>loan_status</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>15000</td>
      <td>Charged Off</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30000</td>
      <td>Fully Paid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2700</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>4500</td>
      <td>Fully Paid</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4800</td>
      <td>Charged Off</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The result is an aligned dataframe <code class="docutils literal notranslate"><span class="pre">test_aligned</span></code> that has the same columns as <code class="docutils literal notranslate"><span class="pre">small_train_dummies</span></code>, the dataframe it was aligned with.
This ensures that the shapes are compatible between training and test set and we will get meaningful results from scikit-learn.
Note that ‘OWN’ column that was previously present in the test set was dropped as it is not present in the training set.
We could also perform an inner join when aligning the dataframes (which is the default in <code class="docutils literal notranslate"><span class="pre">pd.align</span></code> if you don’t specify <code class="docutils literal notranslate"><span class="pre">join</span></code>), so that the aligned dataframes contain all the columns present in either of the dataframes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># if we don&#39;t specify join, an inner join is performed and we retain all the columns</span>
<span class="c1"># in this case we also want to store the new aligned training set</span>
<span class="n">test_aligned</span><span class="p">,</span> <span class="n">train_aligned</span> <span class="o">=</span> <span class="n">small_test_dummies</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">small_train_dummies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_aligned</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>loan_amnt</th>
      <th>loan_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>15000</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>30000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2700</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4500</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>4800</td>
      <td>Charged Off</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>However, that’s not very useful if you already created a model using the original training dataset.</p>
</div>
</div>
<div class="section" id="one-hot-with-sklearn">
<h2>One-hot with sklearn<a class="headerlink" href="#one-hot-with-sklearn" title="Permalink to this headline">¶</a></h2>
<p>Another option (and the one we will use for most of the book) is to do our encoding with scikit-learn. Because scikit-learn has a concept of training and test set, the issue of aligning the data is handled automatically.
The dummy or one-hot encoding in scikit-learn is implemented in the <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>, which is a transformer, just like other preprocessing methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="c1"># By default, OneHotEncoder errors if it sees unknown categories in the test data</span>
<span class="c1"># we will overwrite this behavior by specifying handle_unknown=&#39;ignore&#39;</span>
<span class="c1"># also OneHotEncoder by default outputs scipy sparse matrices, which are more efficient but cumbersome</span>
<span class="c1"># we disable that with sparse=False</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># fit on the training set; stores the categories for each column</span>
<span class="n">ohe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
<span class="c1"># apply one-hot encoding to both training and test set</span>
<span class="n">X_train_ohe</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
<span class="n">X_test_ohe</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">small_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_ohe</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0.,
        1., 0., 0., 0., 1.],
       [0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0.,
        0., 1., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 1., 0., 0., 0.,
        1., 0., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 1., 0., 0.,
        1., 0., 0., 1., 0.],
       [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0.,
        0., 0., 1., 0., 1.],
       [0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0.,
        1., 0., 0., 1., 0.],
       [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 1., 0.,
        0., 0., 0., 1., 0.],
       [0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 1., 0., 1., 0.,
        0., 0., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 1., 0., 0.,
        0., 0., 1., 1., 0.],
       [0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 1.,
        0., 0., 0., 1., 0.],
       [0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 1., 0., 1., 0.,
        0., 0., 0., 1., 0.],
       [0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 1.,
        0., 0., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 1., 0., 0., 0.,
        1., 0., 0., 1., 0.],
       [0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 1., 0., 0.,
        0., 1., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 1., 0., 1., 0.,
        0., 0., 0., 1., 0.]])
</pre></div>
</div>
</div>
</div>
<div class="margin sidebar">
<p class="sidebar-title">Feature names in scikit-learn</p>
<p>While scikit-learn doesn’t output pandas dataframes (for now) we can get feature names for the output of some transformers using the <code class="docutils literal notranslate"><span class="pre">get_feature_names</span></code> method.</p>
</div>
<p>There are two things you might notice in this output: as with all scikit-learn transformations, the output is a numpy array without column names, which can be a bit inconvenient.
Secondly, all the columns have been one-hot-encoded, the loan amount is not present any more.
We can actually get the feature names by using the <code class="docutils literal notranslate"><span class="pre">get_feature_names</span></code> method of the <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;x0_2500&#39;, &#39;x0_4000&#39;, &#39;x0_6000&#39;, &#39;x0_6600&#39;, &#39;x0_8000&#39;, &#39;x0_8425&#39;,
       &#39;x0_10000&#39;, &#39;x0_16000&#39;, &#39;x0_20000&#39;, &#39;x0_25000&#39;, &#39;x0_35000&#39;,
       &#39;x0_40000&#39;, &#39;x1_MORTGAGE&#39;, &#39;x1_RENT&#39;, &#39;x2_A&#39;, &#39;x2_B&#39;, &#39;x2_C&#39;,
       &#39;x2_D&#39;, &#39;x2_E&#39;, &#39;x3_Charged Off&#39;, &#39;x3_Fully Paid&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>By default, the input columns in scikit-learn are named <code class="docutils literal notranslate"><span class="pre">x0</span></code>, <code class="docutils literal notranslate"><span class="pre">x1</span></code> and so on, so what this tells us is that for the first feature, loan amount, several new columns were added to one-hot-encode the observed integer values, which was not what we had in mind. We can get more informative feature names by passing the original dataframe column names to <code class="docutils literal notranslate"><span class="pre">get_feature_names</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">small_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;loan_amnt_2500&#39;, &#39;loan_amnt_4000&#39;, &#39;loan_amnt_6000&#39;,
       &#39;loan_amnt_6600&#39;, &#39;loan_amnt_8000&#39;, &#39;loan_amnt_8425&#39;,
       &#39;loan_amnt_10000&#39;, &#39;loan_amnt_16000&#39;, &#39;loan_amnt_20000&#39;,
       &#39;loan_amnt_25000&#39;, &#39;loan_amnt_35000&#39;, &#39;loan_amnt_40000&#39;,
       &#39;home_ownership_MORTGAGE&#39;, &#39;home_ownership_RENT&#39;, &#39;grade_A&#39;,
       &#39;grade_B&#39;, &#39;grade_C&#39;, &#39;grade_D&#39;, &#39;grade_E&#39;,
       &#39;loan_status_Charged Off&#39;, &#39;loan_status_Fully Paid&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>OneHotEncoder, like all other estimators in scikit-learn, always works on all input columns. So we need to pass it only the column that we want to transform.
So one possible way to do this would be to slice of the categorical columns, transform them with <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>, like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">small_train</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Index([&#39;loan_amnt&#39;, &#39;home_ownership&#39;, &#39;grade&#39;, &#39;loan_status&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_cat</span> <span class="o">=</span> <span class="n">small_train</span><span class="p">[[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]]</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">train_cat_ohe</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_cat</span><span class="p">)</span>
<span class="n">train_cat_ohe</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[0., 1., 0., 0., 1., 0., 0.],
       [1., 0., 0., 0., 0., 1., 0.],
       [1., 0., 0., 0., 1., 0., 0.],
       [0., 1., 0., 0., 1., 0., 0.],
       [1., 0., 0., 0., 0., 0., 1.],
       [1., 0., 0., 0., 1., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [0., 1., 0., 0., 0., 0., 1.],
       [0., 1., 0., 1., 0., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [0., 1., 0., 1., 0., 0., 0.],
       [1., 0., 0., 0., 1., 0., 0.],
       [0., 1., 0., 0., 0., 1., 0.],
       [1., 0., 1., 0., 0., 0., 0.]])
</pre></div>
</div>
</div>
</div>
<p>We can now make this one-hot-encoded array back into a dataframe by using <code class="docutils literal notranslate"><span class="pre">get_feature_names</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_cat_ohe</span><span class="p">,</span>
                            <span class="c1"># create column names</span>
                            <span class="n">columns</span><span class="o">=</span><span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">train_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                            <span class="c1"># keep the old index.</span>
                            <span class="c1"># this is optional but will make joining with the other features easier</span>
                            <span class="n">index</span><span class="o">=</span><span class="n">train_cat</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">train_df_ohe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Then we can concatenate it again with the remaining ‘amount’ feature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df_ohe</span><span class="p">,</span> <span class="n">small_train</span><span class="p">[[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train_df_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
      <th>loan_amnt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>40000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>35000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>8425</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>While this is the result we wanted, this was pretty complicated compared to using <code class="docutils literal notranslate"><span class="pre">pd.get_dummies</span></code>.
Luckily, scikit-learn has another tool that will make this much easier, the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code>.</p>
</div>
<div class="section" id="selecting-columns-in-sklearn">
<h2>Selecting Columns in sklearn<a class="headerlink" href="#selecting-columns-in-sklearn" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> is another meta-estimator, similar to the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>, for combining multiple transformations.
In particular, the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> allows you to apply different transformations to different subsets of the columns.
It’s the only part of scikit-learn that explicitly uses pandas column names, and is made specificly to ease the use of pandas dataframes
as input to scikit-learn models.</p>
<p>In contrast to <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>, which basically applies several transformations in sequence, the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> applies several transformations in parallel,
each on a subset of columns, and then concatenates the results, similar to what we did manually above. This is illustrate in Figure TODO.</p>
<p>TODO new image</p>
<p><img alt=":scale 100%" src="../_images/column_transformer_schematic.png" /></p>
<p>As with the pipeline, there is a <code class="docutils literal notranslate"><span class="pre">make_column_transformer</span></code> helper function to easily create a new column transformer.
The function takes tuples, where each tuple consists of a transformation and the columns the transformation should be applied to.
So to apply the <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code> to only the <code class="docutils literal notranslate"><span class="pre">home_ownership</span></code> and <code class="docutils literal notranslate"><span class="pre">grade</span></code> columns, we could do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">make_column_transformer</span>
<span class="c1"># a single transformation, OneHotEncoder, applied to two columns</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]))</span>
<span class="c1"># now we can pass the full dataset, as the column transformer will do the subsetting for us:</span>
<span class="n">ct</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>ColumnTransformer(transformers=[(&#39;onehotencoder&#39;,
                                 OneHotEncoder(handle_unknown=&#39;ignore&#39;,
                                               sparse=False),
                                 [&#39;home_ownership&#39;, &#39;grade&#39;])])
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">make_column_transformer</span></code> has created <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> object for us with a single transformer. It has also automatically generated a name for the transformer using the lower cased class name, <code class="docutils literal notranslate"><span class="pre">'onehotencoder'</span></code>.
We can now use the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> to transform our dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[0., 1., 0., 0., 1., 0., 0.],
       [1., 0., 0., 0., 0., 1., 0.],
       [1., 0., 0., 0., 1., 0., 0.],
       [0., 1., 0., 0., 1., 0., 0.],
       [1., 0., 0., 0., 0., 0., 1.],
       [1., 0., 0., 0., 1., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [0., 1., 0., 0., 0., 0., 1.],
       [0., 1., 0., 1., 0., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0.],
       [0., 1., 0., 1., 0., 0., 0.],
       [1., 0., 0., 0., 1., 0., 0.],
       [0., 1., 0., 0., 0., 1., 0.],
       [1., 0., 1., 0., 0., 0., 0.]])
</pre></div>
</div>
</div>
</div>
<p>Again, we can get the column names for the output using <code class="docutils literal notranslate"><span class="pre">get_feature_names</span></code>:
TODO this doesn’t take the columns?!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>[&#39;onehotencoder__x0_MORTGAGE&#39;,
 &#39;onehotencoder__x0_RENT&#39;,
 &#39;onehotencoder__x1_A&#39;,
 &#39;onehotencoder__x1_B&#39;,
 &#39;onehotencoder__x1_C&#39;,
 &#39;onehotencoder__x1_D&#39;,
 &#39;onehotencoder__x1_E&#39;]
</pre></div>
</div>
</div>
</div>
<p>As you can see, by default, the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> only keeps the columns that we mentioned.
If we want to keep the remaining columns, we can specify ``remainder=’passthrough’:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]),</span>
                             <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span>
                            <span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 2500, &#39;Fully Paid&#39;],
       [1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 4000, &#39;Fully Paid&#39;],
       [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 40000, &#39;Fully Paid&#39;],
       [0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 35000, &#39;Charged Off&#39;],
       [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 8425, &#39;Fully Paid&#39;],
       [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 6000, &#39;Charged Off&#39;],
       [1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 10000, &#39;Charged Off&#39;],
       [1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 20000, &#39;Fully Paid&#39;],
       [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 10000, &#39;Charged Off&#39;],
       [0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 16000, &#39;Charged Off&#39;],
       [1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 8000, &#39;Charged Off&#39;],
       [0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 6600, &#39;Fully Paid&#39;],
       [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 35000, &#39;Charged Off&#39;],
       [0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 20000, &#39;Fully Paid&#39;],
       [1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 25000, &#39;Charged Off&#39;]],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Typically we would not want the target in our data within scikit-learn, though, so we might want do drop it before, or we might want to specify only to pass through the ‘loan_amnt’ column.
We can pass through only some columns by adding a new transformation in the ColumnTransformer, though instead of passing a scikit-learn transformer, we pass the string <code class="docutils literal notranslate"><span class="pre">'passthrough'</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]),</span>
                             <span class="p">(</span><span class="s1">&#39;passthrough&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">])</span>
                            <span class="p">)</span>
<span class="c1"># we set numpy printoptions to not use scientific notation for nicer output</span>
<span class="c1"># and suppress all but three decimal places</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[    0.,     1.,     0.,     0.,     1.,     0.,     0.,  2500.],
       [    1.,     0.,     0.,     0.,     0.,     1.,     0.,  4000.],
       [    1.,     0.,     0.,     0.,     1.,     0.,     0., 40000.],
       [    0.,     1.,     0.,     0.,     1.,     0.,     0., 35000.],
       [    1.,     0.,     0.,     0.,     0.,     0.,     1.,  8425.],
       [    1.,     0.,     0.,     0.,     1.,     0.,     0.,  6000.],
       [    1.,     0.,     1.,     0.,     0.,     0.,     0., 10000.],
       [    1.,     0.,     1.,     0.,     0.,     0.,     0., 20000.],
       [    0.,     1.,     0.,     0.,     0.,     0.,     1., 10000.],
       [    0.,     1.,     0.,     1.,     0.,     0.,     0., 16000.],
       [    1.,     0.,     1.,     0.,     0.,     0.,     0.,  8000.],
       [    0.,     1.,     0.,     1.,     0.,     0.,     0.,  6600.],
       [    1.,     0.,     0.,     0.,     1.,     0.,     0., 35000.],
       [    0.,     1.,     0.,     0.,     0.,     1.,     0., 20000.],
       [    1.,     0.,     1.,     0.,     0.,     0.,     0., 25000.]])
</pre></div>
</div>
</div>
</div>
<p>If instead, we want to scale the ‘loan_amnt’ column, we can pass <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> instead of <code class="docutils literal notranslate"><span class="pre">'passthrough'</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]),</span>
                             <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">])</span>
                            <span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">small_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[ 0.   ,  1.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   , -1.173],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   , -1.047],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   ,  1.984],
       [ 0.   ,  1.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   ,  1.563],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  1.   , -0.674],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   , -0.879],
       [ 1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   , -0.542],
       [ 1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.3  ],
       [ 0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  1.   , -0.542],
       [ 0.   ,  1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   , -0.037],
       [ 1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   , -0.71 ],
       [ 0.   ,  1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   , -0.828],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   ,  1.563],
       [ 0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.3  ],
       [ 1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.721]])
</pre></div>
</div>
</div>
</div>
<p>Now we can finally transform our test dataset without much work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">small_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([[ 0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   , -0.121],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  1.142],
       [ 0.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   ,  0.   , -1.156],
       [ 0.   ,  1.   ,  0.   ,  1.   ,  0.   ,  0.   ,  0.   , -1.005],
       [ 1.   ,  0.   ,  0.   ,  0.   ,  1.   ,  0.   ,  0.   , -0.98 ]])
</pre></div>
</div>
</div>
</div>
<p>Instead of using the <code class="docutils literal notranslate"><span class="pre">make_column_transformer</span></code> function, we can also directly use the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> class. As with the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>, this allows us to explicitly give names to the different transformers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># this is equivalent to the the column transformer created above</span>
<span class="c1"># each transformation is a tuple (name, transformer, columns)</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([(</span><span class="s1">&#39;ohe&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]),</span>
                        <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b24c0215-cd21-4290-9ded-d0a39faf6379" type="checkbox" ><label class="sk-toggleable__label" for="b24c0215-cd21-4290-9ded-d0a39faf6379">ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder',
                                 OneHotEncoder(handle_unknown='ignore',
                                               sparse=False),
                                 ['home_ownership', 'grade']),
                                ('standardscaler', StandardScaler(),
                                 ['loan_amnt'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="997d69b6-f6ce-4fde-b104-0ed2cffd3fe1" type="checkbox" ><label class="sk-toggleable__label" for="997d69b6-f6ce-4fde-b104-0ed2cffd3fe1">onehotencoder</label><div class="sk-toggleable__content"><pre>['home_ownership', 'grade']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="4f8cdf27-ba77-4386-a742-47dea4464fe3" type="checkbox" ><label class="sk-toggleable__label" for="4f8cdf27-ba77-4386-a742-47dea4464fe3">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown='ignore', sparse=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="428676ae-9ccf-4be7-aedd-197e0916c66b" type="checkbox" ><label class="sk-toggleable__label" for="428676ae-9ccf-4be7-aedd-197e0916c66b">standardscaler</label><div class="sk-toggleable__content"><pre>['loan_amnt']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7fba4ea1-9680-4749-b789-44cda3041bc4" type="checkbox" ><label class="sk-toggleable__label" for="7fba4ea1-9680-4749-b789-44cda3041bc4">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div></div></div></div><div class="output text_html"><style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="fa8f6411-8d88-4c3e-a41a-8c17063551df" type="checkbox" ><label class="sk-toggleable__label" for="fa8f6411-8d88-4c3e-a41a-8c17063551df">ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder',
                                 OneHotEncoder(handle_unknown='ignore',
                                               sparse=False),
                                 ['home_ownership', 'grade']),
                                ('standardscaler', StandardScaler(),
                                 ['loan_amnt'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="c4576bb3-6ae9-44a1-8797-7b189612f047" type="checkbox" ><label class="sk-toggleable__label" for="c4576bb3-6ae9-44a1-8797-7b189612f047">onehotencoder</label><div class="sk-toggleable__content"><pre>['home_ownership', 'grade']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="37621d8f-7313-4916-854d-bb66f18b2f05" type="checkbox" ><label class="sk-toggleable__label" for="37621d8f-7313-4916-854d-bb66f18b2f05">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown='ignore', sparse=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="32f8af97-bf3c-4e5f-a603-201d59a43a51" type="checkbox" ><label class="sk-toggleable__label" for="32f8af97-bf3c-4e5f-a603-201d59a43a51">standardscaler</label><div class="sk-toggleable__content"><pre>['loan_amnt']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="83eaf694-b9e6-497d-a120-f2a4229a1e43" type="checkbox" ><label class="sk-toggleable__label" for="83eaf694-b9e6-497d-a120-f2a4229a1e43">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Diagram representations of estimators
Starting with version 0.23, scikit-learn has diagram representations for estimators when running in jupyter.
These can be enabled using <code class="docutils literal notranslate"><span class="pre">sklearn.set_config</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn</span>
<span class="n">sklearn</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s1">&#39;diagram&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b24c0215-cd21-4290-9ded-d0a39faf6379" type="checkbox" ><label class="sk-toggleable__label" for="b24c0215-cd21-4290-9ded-d0a39faf6379">ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder',
                                 OneHotEncoder(handle_unknown='ignore',
                                               sparse=False),
                                 ['home_ownership', 'grade']),
                                ('standardscaler', StandardScaler(),
                                 ['loan_amnt'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="997d69b6-f6ce-4fde-b104-0ed2cffd3fe1" type="checkbox" ><label class="sk-toggleable__label" for="997d69b6-f6ce-4fde-b104-0ed2cffd3fe1">onehotencoder</label><div class="sk-toggleable__content"><pre>['home_ownership', 'grade']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="4f8cdf27-ba77-4386-a742-47dea4464fe3" type="checkbox" ><label class="sk-toggleable__label" for="4f8cdf27-ba77-4386-a742-47dea4464fe3">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown='ignore', sparse=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="428676ae-9ccf-4be7-aedd-197e0916c66b" type="checkbox" ><label class="sk-toggleable__label" for="428676ae-9ccf-4be7-aedd-197e0916c66b">standardscaler</label><div class="sk-toggleable__content"><pre>['loan_amnt']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7fba4ea1-9680-4749-b789-44cda3041bc4" type="checkbox" ><label class="sk-toggleable__label" for="7fba4ea1-9680-4749-b789-44cda3041bc4">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
<p>In particular for more complex workflows they can come in really handy. Clicking on any of the estimators in the diagram will provide you with more details.</p>
</div>
</div>
<div class="section" id="combining-columntransformer-and-pipeline">
<h2>Combining ColumnTransformer and Pipeline<a class="headerlink" href="#combining-columntransformer-and-pipeline" title="Permalink to this headline">¶</a></h2>
<p>While <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> by itself is already quite awesome, the real power comes from combining it with <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> to encapsulate the whole preprocessing and model training.
Let’s apply <code class="docutils literal notranslate"><span class="pre">KNeighborsClassifier</span></code> to the small subset of the lending club data we have been looking at. This is more for illustrative purposes, as we’re using a tiny subset, and KNeighborsClassifier is potentially not a good model for this dataset, but we will see this combination in many of our later examples.</p>
<p>Let’s start from the beginning create a small dataset with 200 ‘Charged Off’ and 200 ‘Fully Paid’ loans.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;C:/Users/t3kci/Downloads/loan.csv/loan.csv&quot;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">loans_paid</span> <span class="o">=</span> <span class="n">loans</span><span class="p">[</span><span class="n">loans</span><span class="o">.</span><span class="n">loan_status</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Fully Paid&#39;</span><span class="p">,</span> <span class="s1">&#39;Charged Off&#39;</span><span class="p">])]</span>
<span class="n">some_loans</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;loan_status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">some_loans</span><span class="p">[[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">,</span> <span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;loan_status&#39;</span><span class="p">]]</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>home_ownership</th>
      <th>grade</th>
      <th>loan_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>MORTGAGE</td>
      <td>A</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>RENT</td>
      <td>E</td>
      <td>Charged Off</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>MORTGAGE</td>
      <td>C</td>
      <td>Charged Off</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">.</span><span class="n">loan_status</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Fully Paid     200
Charged Off    200
Name: loan_status, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>First, we split off the target column as usual, and split the data into training and test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;loan_status&#39;</span><span class="p">),</span>
                                                    <span class="n">X</span><span class="o">.</span><span class="n">loan_status</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>

<span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>home_ownership</th>
      <th>grade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>332</th>
      <td>12000</td>
      <td>MORTGAGE</td>
      <td>E</td>
    </tr>
    <tr>
      <th>61</th>
      <td>7125</td>
      <td>RENT</td>
      <td>E</td>
    </tr>
    <tr>
      <th>185</th>
      <td>10500</td>
      <td>OWN</td>
      <td>D</td>
    </tr>
    <tr>
      <th>75</th>
      <td>15000</td>
      <td>OWN</td>
      <td>C</td>
    </tr>
    <tr>
      <th>135</th>
      <td>40000</td>
      <td>OWN</td>
      <td>A</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Next, we assemble our <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> as we did above, applying scaling to the <code class="docutils literal notranslate"><span class="pre">loan_amnt</span></code> and applying one-hot encoding to <code class="docutils literal notranslate"><span class="pre">home_ownership</span></code> and <code class="docutils literal notranslate"><span class="pre">grade</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="p">[</span><span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]),</span>
                             <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">]))</span>
<span class="n">ct</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="ea90f3b6-62e1-423c-8587-5db9c8f2c403" type="checkbox" ><label class="sk-toggleable__label" for="ea90f3b6-62e1-423c-8587-5db9c8f2c403">ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder',
                                 OneHotEncoder(handle_unknown='ignore',
                                               sparse=False),
                                 ['home_ownership', 'grade']),
                                ('standardscaler', StandardScaler(),
                                 ['loan_amnt'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="da03318e-42bf-43e8-af36-6205b3302f72" type="checkbox" ><label class="sk-toggleable__label" for="da03318e-42bf-43e8-af36-6205b3302f72">onehotencoder</label><div class="sk-toggleable__content"><pre>['home_ownership', 'grade']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="632ac960-bbe9-4274-aaa5-ffbc304ebc25" type="checkbox" ><label class="sk-toggleable__label" for="632ac960-bbe9-4274-aaa5-ffbc304ebc25">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown='ignore', sparse=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="91e4c8e7-2812-4c4d-b9fd-c64d971666d1" type="checkbox" ><label class="sk-toggleable__label" for="91e4c8e7-2812-4c4d-b9fd-c64d971666d1">standardscaler</label><div class="sk-toggleable__content"><pre>['loan_amnt']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="ef308a63-e729-4e33-8a80-a62eb357073b" type="checkbox" ><label class="sk-toggleable__label" for="ef308a63-e729-4e33-8a80-a62eb357073b">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<p>Now, we use this <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> as a preprocessing step in a <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> with <code class="docutils literal notranslate"><span class="pre">KNeighborsClassifier</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">pipe</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>div.sk-top-container {color: black;background-color: white;}div.sk-toggleable {background-color: white;}label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.2em 0.3em;box-sizing: border-box;text-align: center;}div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}div.sk-estimator {font-family: monospace;background-color: #f0f8ff;margin: 0.25em 0.25em;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;}div.sk-estimator:hover {background-color: #d4ebff;}div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;}div.sk-item {z-index: 1;}div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}div.sk-parallel-item:only-child::after {width: 0;}div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0.2em;box-sizing: border-box;padding-bottom: 0.1em;background-color: white;position: relative;}div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}div.sk-label-container {position: relative;z-index: 2;text-align: center;}div.sk-container {display: inline-block;position: relative;}</style><div class="sk-top-container"><div class="sk-container"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="69a7ac06-7d0b-42b4-bf98-9c7bc84515f8" type="checkbox" ><label class="sk-toggleable__label" for="69a7ac06-7d0b-42b4-bf98-9c7bc84515f8">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('columntransformer',
                 ColumnTransformer(transformers=[('onehotencoder',
                                                  OneHotEncoder(handle_unknown='ignore',
                                                                sparse=False),
                                                  ['home_ownership', 'grade']),
                                                 ('standardscaler',
                                                  StandardScaler(),
                                                  ['loan_amnt'])])),
                ('kneighborsclassifier', KNeighborsClassifier(n_neighbors=1))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="6e7ddebe-8130-4567-a3c8-6f522ca04605" type="checkbox" ><label class="sk-toggleable__label" for="6e7ddebe-8130-4567-a3c8-6f522ca04605">columntransformer: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(transformers=[('onehotencoder',
                                 OneHotEncoder(handle_unknown='ignore',
                                               sparse=False),
                                 ['home_ownership', 'grade']),
                                ('standardscaler', StandardScaler(),
                                 ['loan_amnt'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="d83cdd3e-c512-4844-af00-b8dee068e6f2" type="checkbox" ><label class="sk-toggleable__label" for="d83cdd3e-c512-4844-af00-b8dee068e6f2">onehotencoder</label><div class="sk-toggleable__content"><pre>['home_ownership', 'grade']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="a076a832-8da9-441a-ad68-66abc6619ff1" type="checkbox" ><label class="sk-toggleable__label" for="a076a832-8da9-441a-ad68-66abc6619ff1">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(handle_unknown='ignore', sparse=False)</pre></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="014ccc05-3962-4349-8b62-72e82a4af0e1" type="checkbox" ><label class="sk-toggleable__label" for="014ccc05-3962-4349-8b62-72e82a4af0e1">standardscaler</label><div class="sk-toggleable__content"><pre>['loan_amnt']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="3510de64-9b63-4ba4-8715-20b38d96fb9b" type="checkbox" ><label class="sk-toggleable__label" for="3510de64-9b63-4ba4-8715-20b38d96fb9b">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="2960b1f2-2b7a-4188-af96-bb5f28892b5b" type="checkbox" ><label class="sk-toggleable__label" for="2960b1f2-2b7a-4188-af96-bb5f28892b5b">KNeighborsClassifier</label><div class="sk-toggleable__content"><pre>KNeighborsClassifier(n_neighbors=1)</pre></div></div></div></div></div></div></div></div></div>
</div>
<p>Now, everything we need to do is embedded in the <code class="docutils literal notranslate"><span class="pre">pipe</span></code> object, and we can just run <code class="docutils literal notranslate"><span class="pre">fit</span></code> on the training set and <code class="docutils literal notranslate"><span class="pre">score</span></code> on the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0.59
</pre></div>
</div>
</div>
</div>
<p>The result here is not too overwhelming, but a bit better than chance (which would be 50%, given that we constructed a balanced dataset).
However, the overall code for building and evaluating the model was quite minimal, and leaves little opportunity for casual mistakes.</p>
</div>
<div class="section" id="selecting-columns-by-type">
<h2>Selecting columns by type<a class="headerlink" href="#selecting-columns-by-type" title="Permalink to this headline">¶</a></h2>
<p>If there are many columns, such as in the full lending club data, it can sometimes be a challenge to determine the types and correct preprocessing for all of them.
Usually, it pays of to understand each individual column, and invest some time understanding the meaning of all the values, plotting them, and so on.
For example, for integer values it might not be obvious whether they should be one-hot-encoded or not. The annual salary amount in the lending club data is continuous, but the easiest way to actually be certain about that is to know what the data represents. We know salary, or really any amount of money, will be continuous. Luckily in this dataset all the categorical variable are represented as strings, and so it’s relatively easy to understand what they mean.
But without additional information, if a column contains small integers, these could either correspond to a continuous quantity, or be an encoding for categories.</p>
<p>This somewhat tricky case aside, for some quick plotting or prototyping, it might sometimes be enough to look at just the dtype of the columns.
Let’s look again at the dtypes of the full lending club data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>float64    70
int64      39
object     36
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>We could select only column of a certain type by using boolean masks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># only select &#39;object&#39; dtype columns, which are usually strings</span>
<span class="n">loans</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">loans</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>term</th>
      <th>grade</th>
      <th>sub_grade</th>
      <th>emp_title</th>
      <th>emp_length</th>
      <th>home_ownership</th>
      <th>verification_status</th>
      <th>issue_d</th>
      <th>loan_status</th>
      <th>pymnt_plan</th>
      <th>...</th>
      <th>hardship_status</th>
      <th>hardship_start_date</th>
      <th>hardship_end_date</th>
      <th>payment_plan_start_date</th>
      <th>hardship_loan_status</th>
      <th>disbursement_method</th>
      <th>debt_settlement_flag</th>
      <th>debt_settlement_flag_date</th>
      <th>settlement_status</th>
      <th>settlement_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36 months</td>
      <td>C</td>
      <td>C1</td>
      <td>Chef</td>
      <td>10+ years</td>
      <td>RENT</td>
      <td>Not Verified</td>
      <td>Dec-2018</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Cash</td>
      <td>N</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>60 months</td>
      <td>D</td>
      <td>D2</td>
      <td>Postmaster</td>
      <td>10+ years</td>
      <td>MORTGAGE</td>
      <td>Source Verified</td>
      <td>Dec-2018</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Cash</td>
      <td>N</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36 months</td>
      <td>D</td>
      <td>D1</td>
      <td>Administrative</td>
      <td>6 years</td>
      <td>MORTGAGE</td>
      <td>Source Verified</td>
      <td>Dec-2018</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Cash</td>
      <td>N</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36 months</td>
      <td>D</td>
      <td>D2</td>
      <td>IT Supervisor</td>
      <td>10+ years</td>
      <td>MORTGAGE</td>
      <td>Source Verified</td>
      <td>Dec-2018</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Cash</td>
      <td>N</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>60 months</td>
      <td>C</td>
      <td>C4</td>
      <td>Mechanic</td>
      <td>10+ years</td>
      <td>MORTGAGE</td>
      <td>Not Verified</td>
      <td>Dec-2018</td>
      <td>Current</td>
      <td>n</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Cash</td>
      <td>N</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 36 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">loans</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Index([&#39;id&#39;, &#39;member_id&#39;, &#39;funded_amnt_inv&#39;, &#39;int_rate&#39;, &#39;installment&#39;,
       &#39;annual_inc&#39;, &#39;url&#39;, &#39;dti&#39;, &#39;inq_last_6mths&#39;, &#39;mths_since_last_delinq&#39;,
       &#39;mths_since_last_record&#39;, &#39;revol_util&#39;, &#39;out_prncp&#39;, &#39;out_prncp_inv&#39;,
       &#39;total_pymnt&#39;, &#39;total_pymnt_inv&#39;, &#39;total_rec_prncp&#39;, &#39;total_rec_int&#39;,
       &#39;total_rec_late_fee&#39;, &#39;recoveries&#39;, &#39;collection_recovery_fee&#39;,
       &#39;last_pymnt_amnt&#39;, &#39;mths_since_last_major_derog&#39;, &#39;annual_inc_joint&#39;,
       &#39;dti_joint&#39;, &#39;open_acc_6m&#39;, &#39;open_act_il&#39;, &#39;open_il_12m&#39;, &#39;open_il_24m&#39;,
       &#39;mths_since_rcnt_il&#39;, &#39;total_bal_il&#39;, &#39;il_util&#39;, &#39;open_rv_12m&#39;,
       &#39;open_rv_24m&#39;, &#39;max_bal_bc&#39;, &#39;all_util&#39;, &#39;inq_fi&#39;, &#39;total_cu_tl&#39;,
       &#39;inq_last_12m&#39;, &#39;avg_cur_bal&#39;, &#39;bc_open_to_buy&#39;, &#39;bc_util&#39;,
       &#39;mo_sin_old_il_acct&#39;, &#39;mths_since_recent_bc&#39;,
       &#39;mths_since_recent_bc_dlq&#39;, &#39;mths_since_recent_inq&#39;,
       &#39;mths_since_recent_revol_delinq&#39;, &#39;num_tl_120dpd_2m&#39;, &#39;pct_tl_nvr_dlq&#39;,
       &#39;percent_bc_gt_75&#39;, &#39;revol_bal_joint&#39;, &#39;sec_app_inq_last_6mths&#39;,
       &#39;sec_app_mort_acc&#39;, &#39;sec_app_open_acc&#39;, &#39;sec_app_revol_util&#39;,
       &#39;sec_app_open_act_il&#39;, &#39;sec_app_num_rev_accts&#39;,
       &#39;sec_app_chargeoff_within_12_mths&#39;,
       &#39;sec_app_collections_12_mths_ex_med&#39;,
       &#39;sec_app_mths_since_last_major_derog&#39;, &#39;deferral_term&#39;,
       &#39;hardship_amount&#39;, &#39;hardship_length&#39;, &#39;hardship_dpd&#39;,
       &#39;orig_projected_additional_accrued_interest&#39;,
       &#39;hardship_payoff_balance_amount&#39;, &#39;hardship_last_payment_amount&#39;,
       &#39;settlement_amount&#39;, &#39;settlement_percentage&#39;, &#39;settlement_term&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>Some of these are categorical, some of these are dates (which we might choose to drop or parse as dates), but some of these might even have continuous aspects, such as the employment length:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="o">.</span><span class="n">emp_length</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>10+ years    333964
2 years       90476
&lt; 1 year      81758
3 years       81013
1 year        66927
5 years       61623
4 years       61101
6 years       43380
8 years       38349
7 years       34708
9 years       32224
Name: emp_length, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>If you feel that dtypes are a good way to select features on your dataset, you can do so in <code class="docutils literal notranslate"><span class="pre">ColumnTransformers</span></code> even more easily with <code class="docutils literal notranslate"><span class="pre">make_column_selector</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">make_column_selector</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="c1"># pass object dtype columns to OneHotEncoder</span>
                             <span class="n">make_column_selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)),</span>
                             <span class="c1"># pass float and int dtypes to StandardScaler</span>
                             <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">make_column_selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">])))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># we&#39;re only using some of the columns as the whole dataset is quite messy</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">some_loans</span><span class="p">[[</span><span class="s1">&#39;loan_amnt&#39;</span><span class="p">,</span> <span class="s1">&#39;int_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;home_ownership&#39;</span><span class="p">,</span> <span class="s1">&#39;open_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]]</span>
<span class="n">X</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>loan_amnt           int64
int_rate          float64
home_ownership     object
open_acc            int64
grade              object
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ct</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># we can look at the fitted transformers to see which columns where passed where</span>
<span class="n">ct</span><span class="o">.</span><span class="n">transformers_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>[(&#39;onehotencoder&#39;,
  OneHotEncoder(handle_unknown=&#39;ignore&#39;, sparse=False),
  [&#39;home_ownership&#39;, &#39;grade&#39;]),
 (&#39;standardscaler&#39;, StandardScaler(), [&#39;int_rate&#39;]),
 (&#39;remainder&#39;, &#39;drop&#39;, [0, 3])]
</pre></div>
</div>
</div>
</div>
<p>The benefit of using <code class="docutils literal notranslate"><span class="pre">make_column_selector</span></code> instead of passing a boolean mask is that the correct columns are determined when fitting the <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> which avoids mistakes when creating the mask.
The <code class="docutils literal notranslate"><span class="pre">make_column_selector</span></code> function can also match column names or exclude certain dtypes.</p>
</div>
<div class="section" id="collinearity-redundancy">
<h2>Collinearity &amp; Redundancy<a class="headerlink" href="#collinearity-redundancy" title="Permalink to this headline">¶</a></h2>
<div class="sidebar">
<p class="sidebar-title">One-hot vs dummy naming</p>
<p>In some communities, one-hot encoding refers to using one column per category, while dummy encoding refers to leaving out one of them. Using this nomenclature, <code class="docutils literal notranslate"><span class="pre">pd.get_dummies</span></code> does one-hot encoding by default.
In pandas and scikit-learn the terms are used interchangeably and we’re using them interchangeably in this book. TODO is this a good idea?</p>
</div>
<p>Coming back to one-hot encoding, there’s one more important thing to know, which is that one-hot encoding is redundant. We can drop one of the columns for each categorical variable and still retain all the information: if all of the other columns are zero, the dropped one was 1, and if one of them is 1, the dropped one was 0. In other words, you could re-compute a column as one minus the sum of the other columns. Such a relationship is known as collinearity (or linear dependency). For some statistical models, the presence of such a relationship between the features can lead to numerical and statistical issues. Therefore, it is common in statistics to drop one of the columns. You can do that in pandas by using <code class="docutils literal notranslate"><span class="pre">pd.get_dummies(X,</span> <span class="pre">drop_first=True)</span></code> which will drop the first category for each feature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>int_rate</th>
      <th>open_acc</th>
      <th>home_ownership_ANY</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_A</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
      <th>grade_F</th>
      <th>grade_G</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>6.46</td>
      <td>12</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>14.47</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>8.81</td>
      <td>7</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>27.27</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>16.14</td>
      <td>22</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loan_amnt</th>
      <th>int_rate</th>
      <th>open_acc</th>
      <th>home_ownership_MORTGAGE</th>
      <th>home_ownership_OWN</th>
      <th>home_ownership_RENT</th>
      <th>grade_B</th>
      <th>grade_C</th>
      <th>grade_D</th>
      <th>grade_E</th>
      <th>grade_F</th>
      <th>grade_G</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8000</td>
      <td>6.46</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6000</td>
      <td>14.47</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>8.81</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>27.27</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>35000</td>
      <td>16.14</td>
      <td>22</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>, you can specify <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code> if you want to drop the first category, or you can specify the category you want to drop for each of the features.
The only model in scikit-learn for which retaining all of the feature is an issue is <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> (which we’ll discuss in Chapter TODO), but otherwise you don’t have to worry about it. For many of the model in sklearn that we’ll see in Chapter TODO, it can matter which feature you drop, and it might be harder to interpret the model once you do. Therefore I usually recommend keeping all features in one-hot-encoding, even though the representation is redundant.</p>
<div class="section" id="dropping-redundant-binary-features">
<h3>Dropping redundant binary features<a class="headerlink" href="#dropping-redundant-binary-features" title="Permalink to this headline">¶</a></h3>
<p>There is one exception though, which is binary features. If you have a binary categorical feature, i.e. a feature with two categories, it is obviously redundant to encode it using OneHotEncoder. Let’s look at the ‘term’ variable which has two values, ‘36 months’ and ‘60 months’:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span> 36 months    715939
 60 months    284061
Name: term, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>If we encode this feature using OneHotEncoder, we will get two new features, one corresponding to the 36s month term, and the other to the 50 months term:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loans</span><span class="p">[[</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]])</span>
<span class="c1"># get feature names, passing in the original feature names</span>
<span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">([</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;term_ 36 months&#39;, &#39;term_ 60 months&#39;, &#39;grade_A&#39;, &#39;grade_B&#39;,
       &#39;grade_C&#39;, &#39;grade_D&#39;, &#39;grade_E&#39;, &#39;grade_F&#39;, &#39;grade_G&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<p>However, these two features encode exactly the same information, in that the 36 months term feature is just 1 minus the 60 month term feature. This redundancy is not useful and will make any model less easy to interpret, and we can drop it using <code class="docutils literal notranslate"><span class="pre">drop='if_binary'</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;if_binary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loans</span><span class="p">[[</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">]])</span>
<span class="n">ohe</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">([</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;term_ 60 months&#39;, &#39;grade_A&#39;, &#39;grade_B&#39;, &#39;grade_C&#39;, &#39;grade_D&#39;,
       &#39;grade_E&#39;, &#39;grade_F&#39;, &#39;grade_G&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Now there’s only one feature to represent this information, while the ‘grade’ feature with seven categories has retained all columns.</p>
</div>
</div>
<div class="section" id="impact-encoding-dealing-with-many-categories">
<h2>Impact Encoding &amp; Dealing with many categories<a class="headerlink" href="#impact-encoding-dealing-with-many-categories" title="Permalink to this headline">¶</a></h2>
<p>Dealing with categorical features with many categories can be a bit tricky, as directly applying one-hot encoding is often not effective.
Let’s look at the <code class="docutils literal notranslate"><span class="pre">emp_title</span></code> feature from the lending club data, which provides a job description of the borrower:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans_paid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(383181, 145)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">title_counts</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">title_counts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Teacher                                 6819
Manager                                 6609
Owner                                   3977
Driver                                  2982
Registered Nurse                        2859
                                        ... 
Corporate Delivery Specialist              1
telecom                                    1
Sewer Manitenance supervisor 1             1
Regulatory Compliance Survey Manager       1
Lead payroll admin                         1
Name: emp_title, Length: 108751, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>We loaded 1,000,000 rows of data, and it contains 224,610 different employment titles. Several of the titles are very common, such as Teacher and Manager, while some of the titles appear only once, like ‘Court Evaluator’. TODO numbers
Let’s see how many of the value appear only once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">title_once</span> <span class="o">=</span> <span class="n">title_counts</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">title_once</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>85905
</pre></div>
</div>
</div>
</div>
<p>That’s most of them! Clearly it will be hard to learn from a category for which we have only seen one example. This is likely another example of a power-law distribution: most of the job titles appear only once, there are some that appear several times, but then there are some that appear much more frequently than all the rest, such as Teacher and Manager. We can validate this by looking at the counts of the counts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># a power-law distribution looks like a straight line in a log-log plot. This seems to hold reasonably well here.</span>
<span class="n">title_counts</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x269a21cfbc8&gt;
</pre></div>
</div>
<img alt="../_images/04-categorical-variables_109_1.png" src="../_images/04-categorical-variables_109_1.png" />
</div>
</div>
<p>Using a one-hot encoding on 224,610 categories will produce a feature space that will likely make learning hard. Even if we restrict ourselves to the categories that appear at least twice, we would still have over 50,000 features.
One option is to define a cut-off, and only look at the top k, say top 50 or top 100, most common values, and move everything else into an “other” category. Let’s have a look at what the common values are:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">title_counts</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;50 most common job titles&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;50 most common job titles&#39;)
</pre></div>
</div>
<img alt="../_images/04-categorical-variables_111_1.png" src="../_images/04-categorical-variables_111_1.png" />
</div>
</div>
<p>Before we start encoding the feature, we might want to look at whether these are informative at all. We can for example look at how frequently each is associated with a fully paid loan.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># look at only the loans associated with a common job title</span>
<span class="n">loans_50_jobs</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="p">[</span><span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">title_counts</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="n">loans_50_jobs</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(70672, 145)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ensure our subsetting did what we wanted it to:</span>
<span class="n">loans_50_jobs</span><span class="o">.</span><span class="n">emp_title</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([&#39;Supervisor &#39;, &#39;Teacher&#39;, &#39;Manager&#39;, &#39;Police Officer&#39;,
       &#39;Truck Driver&#39;, &#39;Project Manager&#39;, &#39;Driver&#39;, &#39;supervisor&#39;,
       &#39;Registered Nurse&#39;, &#39;Operations Manager&#39;, &#39;Vice President&#39;,
       &#39;Program Manager&#39;, &#39;Executive Assistant&#39;, &#39;Sales&#39;, &#39;Supervisor&#39;,
       &#39;RN&#39;, &#39;Sales Manager&#39;, &#39;Software Engineer&#39;, &#39;Controller&#39;,
       &#39;Assistant Manager&#39;, &#39;Account Manager&#39;, &#39;manager&#39;,
       &#39;General Manager&#39;, &#39;President&#39;, &#39;Paralegal&#39;, &#39;Administrator&#39;,
       &#39;Director&#39;, &#39;Branch Manager&#39;, &#39;Mechanic&#39;, &#39;Technician&#39;,
       &#39;Accountant&#39;, &#39;Owner&#39;, &#39;Analyst&#39;, &#39;driver&#39;, &#39;teacher&#39;, &#39;Engineer&#39;,
       &#39;Store Manager&#39;, &#39;owner&#39;, &#39;Nurse&#39;, &#39;Administrative Assistant&#39;,
       &#39;Office Manager&#39;, &#39;Attorney&#39;, &#39;Server&#39;, &#39;sales&#39;, &#39;Foreman&#39;,
       &#39;Truck driver&#39;, &#39;Consultant&#39;, &#39;Electrician&#39;, &#39;Registered nurse&#39;,
       &#39;CEO&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># group by the employment title and take the loan status column</span>
<span class="n">loan_status_by_title</span> <span class="o">=</span> <span class="n">loans_50_jobs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;emp_title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loan_status</span>
<span class="c1"># some panda kung-fu: for each title, compute rations of fully paid and charged off, take only fully paid ones</span>
<span class="n">paid_fraction</span> <span class="o">=</span> <span class="n">loan_status_by_title</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;loan_status&#39;</span><span class="p">)[</span><span class="s1">&#39;Fully Paid&#39;</span><span class="p">]</span>
<span class="c1"># TODO seaborn will make this better!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paid_fraction</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">overall_payment_ratio</span> <span class="o">=</span> <span class="n">loans_50_jobs</span><span class="o">.</span><span class="n">loan_status</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;Fully Paid&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">overall_payment_ratio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fraction fully paid&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;Fraction fully paid&#39;)
</pre></div>
</div>
<img alt="../_images/04-categorical-variables_116_1.png" src="../_images/04-categorical-variables_116_1.png" />
</div>
</div>
<p>This plot shows that there seems to be some information in the employment title. You might also note that some of the titles have capitalized an uncapitalized variants. In principle, the spelling difference could contain additional information. However, at least when looking directly at the outcomes, the different capitalization variants largely have the same outcomes (we could do a more rigorous statistical analysis for this if we were interested). Consolidating the capitalization could be done simply by lowercasing everything:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans_paid</span><span class="p">[</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="p">[</span><span class="s1">&#39;emp_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="stderr docutils container">
<pre class="stderr literal-block">C:\Users\t3kci\anaconda3\lib\site-packages\ipykernel_launcher.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  &quot;&quot;&quot;Entry point for launching an IPython kernel.
</pre>
</div>
</div>
</div>
<p>If you explore the dataset more, you’ll find that there are also misspellings, which are a bit harder to correct and which we’ll leave for now.
After we consolidated the capitalization we can replace all but the 50 most common titles by “other”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">title_counts_lower</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title_lower</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">common_titles</span> <span class="o">=</span> <span class="n">title_counts_lower</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
<span class="n">loans_paid</span><span class="p">[</span><span class="s1">&#39;emp_title_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="p">[</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">common_titles</span> <span class="k">else</span> <span class="s1">&#39;other&#39;</span><span class="p">)</span>
<span class="n">loans_paid</span><span class="p">[</span><span class="s1">&#39;emp_title_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="stderr docutils container">
<pre class="stderr literal-block">C:\Users\t3kci\anaconda3\lib\site-packages\ipykernel_launcher.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  This is separate from the ipykernel package so we can avoid doing imports until
</pre>
</div>
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>other                       297838
manager                       8162
teacher                       8071
owner                         5769
driver                        4104
registered nurse              3850
supervisor                    3569
sales                         3486
rn                            3169
project manager               2444
general manager               2268
office manager                2265
truck driver                  2037
director                      1788
president                     1682
engineer                      1630
sales manager                 1542
operations manager            1388
police officer                1319
nurse                         1268
accountant                    1229
vice president                1220
store manager                 1215
technician                    1153
mechanic                      1108
account manager               1051
administrative assistant      1040
attorney                       984
analyst                        962
server                         923
branch manager                 871
assistant manager              868
executive assistant            832
paralegal                      779
foreman                        763
electrician                    756
software engineer              747
customer service               745
operator                       745
supervisor                     722
clerk                          682
controller                     669
machine operator               667
ceo                            666
consultant                     663
program manager                642
administrator                  634
it manager                     551
manager                        549
business analyst               548
principal                      548
Name: emp_title_50, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Now, we have a relatively clean categorical variable, with only 51 values, which we can easily one-hot encode. TODO better transition</p>
<div class="section" id="impact-encoding">
<h3>Impact encoding<a class="headerlink" href="#impact-encoding" title="Permalink to this headline">¶</a></h3>
<p>There is one more encoding scheme for categorical data that is commonly used and that recently has increased in popularity, known as impact encoding or target encoding.
This method of encoding categorical variables uses information about the classification target and is particularly useful for categorical features with many categories.</p>
<p>The idea behind impact encoding is to replace the categorical feature by the average outcome of the respective category.
In our case of employment title, the feature would become something like “likelihood of fully paying based on job title alone”, i.e. the value for the job title in Figure TODO. In other words, if we want to encode a value of, say, ‘ceo’, we look at the average frequency of of loans with ‘emp_title’ ceo to be fully paid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># should we recompute with lower-cased here? Or get rid of lower-casing?</span>
<span class="n">paid_fraction</span><span class="p">[</span><span class="s1">&#39;CEO&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0.7534013605442177
</pre></div>
</div>
</div>
</div>
<p>So any time we would an ‘emp_title’ of ‘CEO’ our new feature (which will take the place of ‘emp_title’) will be 0.75…</p>
<p>In principle we could compute this new feature using pandas alone by first computing the paid fraction (redoing it for all titles, not just the top 50, and taking lower-casing into account):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fill in emp_title_lower with &quot;missing&quot; where it&#39;s missing (otherwise these will be ignored)</span>
<span class="c1"># inplace means we&#39;re overwriting the existing column</span>
<span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title_lower</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;missing&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># redoing the pandas trickery from above</span>
<span class="n">paid_fraction_full</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loan_status</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;loan_status&#39;</span><span class="p">)[</span><span class="s1">&#39;Fully Paid&#39;</span><span class="p">]</span>
<span class="c1"># NaN means none were paid</span>
<span class="n">paid_fraction_full</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="stderr docutils container">
<pre class="stderr literal-block">C:\Users\t3kci\anaconda3\lib\site-packages\pandas\core\generic.py:6245: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  self._update_inplace(new_data)
</pre>
</div>
</div>
</div>
<p>And then adding the new feature based on <code class="docutils literal notranslate"><span class="pre">emp_title</span></code> to each row:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paid_fraction_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>emp_title_lower
 \toffice manager/medical assistant         0.0
 \tsecurity guard                           1.0
  ag                                        1.0
  assembler                                 0.0
  diversion investigator                    1.0
                                           ... 
zoo keeper                                  0.0
zoo lab coordinator                         0.0
zookeeper                                   1.0
zpic coordinator                            1.0
| principal business solution architect|    1.0
Name: Fully Paid, Length: 92041, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paid_fraction_full</span><span class="p">[</span><span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title_lower</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>emp_title_lower
supervisor                              0.722992
assistant to the treasurer (payroll)    1.000000
teacher                                 0.784661
accounts examiner iii                   1.000000
senior director risk management         1.000000
                                          ...   
systems engineer                        0.843284
accounting                              0.782178
account rep                             0.833333
lpn                                     0.715953
equipment maint supervisor              1.000000
Name: Fully Paid, Length: 383181, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">loans_paid</span><span class="o">.</span><span class="n">emp_title_lower</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>100                                supervisor 
152       assistant to the treasurer (payroll)
170                                    teacher
186                      accounts examiner iii
215            senior director risk management
                          ...                 
999995                        systems engineer
999996                              accounting
999997                             account rep
999998                                     lpn
999999              equipment maint supervisor
Name: emp_title_lower, Length: 383181, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paid_fraction_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>emp_title_lower
 \toffice manager/medical assistant         0.0
 \tsecurity guard                           1.0
  ag                                        1.0
  assembler                                 0.0
  diversion investigator                    1.0
                                           ... 
zoo keeper                                  0.0
zoo lab coordinator                         0.0
zookeeper                                   1.0
zpic coordinator                            1.0
| principal business solution architect|    1.0
Name: Fully Paid, Length: 92041, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># we use join to map &#39;emp_title_lower&#39; to the faction using the content of paid_fraction_full</span>
<span class="n">loans_paid_new</span> <span class="o">=</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paid_fraction_full</span><span class="p">,</span> <span class="s1">&#39;emp_title_lower&#39;</span><span class="p">)</span>
<span class="c1"># show the result; the new column is somewhat confusingly called &#39;Fully Paid&#39; and we should probably rename it</span>
<span class="n">loans_paid_new</span><span class="p">[[</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;Fully Paid&#39;</span><span class="p">,</span> <span class="s1">&#39;loan_status&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>emp_title_lower</th>
      <th>Fully Paid</th>
      <th>loan_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>100</th>
      <td>supervisor</td>
      <td>0.722992</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>152</th>
      <td>assistant to the treasurer (payroll)</td>
      <td>1.000000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>170</th>
      <td>teacher</td>
      <td>0.784661</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>186</th>
      <td>accounts examiner iii</td>
      <td>1.000000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>215</th>
      <td>senior director risk management</td>
      <td>1.000000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>269</th>
      <td>front office lead</td>
      <td>0.600000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>271</th>
      <td>sewell collision center</td>
      <td>1.000000</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>296</th>
      <td>manager</td>
      <td>0.759863</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>369</th>
      <td>service advisor</td>
      <td>0.735294</td>
      <td>Fully Paid</td>
    </tr>
    <tr>
      <th>379</th>
      <td>stylist</td>
      <td>0.738739</td>
      <td>Fully Paid</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>However, there’s two caveats to this (relatively) simple approach: for a classification task like this, it might be beneficial to encode using the <em>log-odds</em> of the target (which is a simple non-linear transformation) instead of using the frequency (it will become clear why in Chapter TODO). Also, if a category appears only rarely, of just once, then the feature will be deceptively informative. If there is just one sample, the feature will encode just the target of this row. This is a typical case of information leakage. The resulting model is likely to learn that this column is particularly useful, though this knowledge will not translate to unseen data.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>You can install the category_encoders package by running <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">category_encoders</span></code> on the command line.</p>
</div>
<p>There are a couple of work-arounds for this, that we won’t discuss in detail here, that either use additional hold-out sets or smoothing. Many of them are implemented in the <code class="docutils literal notranslate"><span class="pre">category_encoders</span></code> package, from which I’ll particulary recomment the TargetEncoder (which implements todo) and GLMMEncoder (which implements TODO), which was shown to work well in practice todo reference masters thesis.
The <code class="docutils literal notranslate"><span class="pre">category_encoder</span></code> package broadly follows the API of scikit-learn, but also allows you to specify which columns the encoding should be applied to. So you can either use this feature, or the ColumnTransformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># TargetEncoder implements a smoothing variant from </span>
<span class="kn">from</span> <span class="nn">category_encoders</span> <span class="kn">import</span> <span class="n">TargetEncoder</span>
<span class="n">te</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">loans_paid</span><span class="p">[[</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">]],</span> <span class="n">loans_paid</span><span class="o">.</span><span class="n">loan_status</span> <span class="o">==</span> <span class="s1">&#39;Fully Paid&#39;</span><span class="p">)</span>
<span class="n">te</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">loans_paid</span><span class="p">[[</span><span class="s1">&#39;emp_title_lower&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>emp_title_lower</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>100</th>
      <td>0.722992</td>
    </tr>
    <tr>
      <th>152</th>
      <td>0.775412</td>
    </tr>
    <tr>
      <th>170</th>
      <td>0.784661</td>
    </tr>
    <tr>
      <th>186</th>
      <td>0.939599</td>
    </tr>
    <tr>
      <th>215</th>
      <td>0.775412</td>
    </tr>
    <tr>
      <th>269</th>
      <td>0.603155</td>
    </tr>
    <tr>
      <th>271</th>
      <td>0.775412</td>
    </tr>
    <tr>
      <th>296</th>
      <td>0.759863</td>
    </tr>
    <tr>
      <th>369</th>
      <td>0.735294</td>
    </tr>
    <tr>
      <th>379</th>
      <td>0.738739</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>You can see that for categories with many samples, such as supervisor and teacher, the feature is identical to what we computed above, whereas for those with less features, such as ‘sewell collision center’, the estimate is much lower.</p>
<div class="margin sidebar">
<p class="sidebar-title">TODO</p>
<p>maybe do a classification example with this?</p>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Categorical variables are quite common in many different settings, and while some models might be able to deal with them natively, preprocessing is necessary for most machine learning models. Using one-hot-encoding is the most common method and usually a good place to start. If there are many categories, it might be useful to encode only the most common ones, and combine all the infrequent ones.
Another common approach to dealing with categorical variables with many categories is target encoding, which is implemented in several variants in the <code class="docutils literal notranslate"><span class="pre">category_encoders</span></code> package.</p>
</div>
</div>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="03-preprocessing.html" title="previous page">Preprocessing and Scaling</a>
    <a class='right-next' id="next-link" href="08-imputation.html" title="next page">Missing Values</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Andreas C. Müller<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>